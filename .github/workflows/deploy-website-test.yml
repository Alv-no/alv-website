name: Deploy test website

on:
  push:
    branches:
      - master
      - main

env:
  ENV: test

jobs:
  get-build-tag:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    outputs:
      buildTag: ${{ steps.create_build_tag.outputs.buildTag }}
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Create build tag
        id: create_build_tag
        shell: bash
        run: echo "buildTag=\"$(git rev-parse --short HEAD)-${{ github.run_id }}-${{ github.run_attempt }}\"" >> $GITHUB_OUTPUT
    
  get-secrets:
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    outputs:
      alvHostname: ${{ steps.get_secrets.outputs.alvHostname }}
      sanityToken: ${{ steps.get_secrets.outputs.sanityToken }}
      youtubeApiToken: ${{ steps.get_secrets.outputs.youtubeApiToken }}
      spAlvtimeAdminClientId: ${{ steps.get_secrets.outputs.spAlvtimeAdminClientId }}
      spAlvtimeAdminRbacSecret: ${{ steps.get_secrets.outputs.spAlvtimeAdminRbacSecret }}

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Azure and set subscription
        shell: bash
        run: |
          az login --service-principal \
            -u "${{ vars.INFRA_TEST_SP_CLIENT_ID }}" \
            -p "${{ secrets.INFRA_TEST_SP_SECRET }}" \
            --tenant "${{ vars.TENANT_ID }}"
          az account set --subscription "${{ vars.SUBSCRIPTION_ID_TEST }}"

      - name: Get Secret from Azure Key Vault
        id: get_secrets
        run: |
          # Get secrets from key vault
          ALV_HOSTNAME=$(az keyvault secret show --name "alv-hostname" --vault-name "${{ vars.KEY_VAULT_TEST }}" --query "value" -o tsv)
          SANITY_TOKEN=$(az keyvault secret show --name "sanity-token" --vault-name "${{ vars.KEY_VAULT_TEST }}" --query "value" -o tsv)
          YOUTUBE_API_TOKEN=$(az keyvault secret show --name "youtube-api-token" --vault-name "${{ vars.KEY_VAULT_TEST }}" --query "value" -o tsv)
          SP_ALVTIME_ADMIN_CLIENT_ID=$(az keyvault secret show --name "sp-alvtime-admin-client-id" --vault-name "${{ vars.KEY_VAULT_TEST }}" --query "value" -o tsv)
          SP_ALVTIME_ADMIN_RBAC_SECRET=$(az keyvault secret show --name "sp-alvtime-admin-rbac-secret" --vault-name "${{ vars.KEY_VAULT_TEST }}" --query "value" -o tsv)

          # Set job outputs
          echo "alvHostname=$ALV_HOSTNAME" >> $GITHUB_OUTPUT
          echo "sanityToken=$SANITY_TOKEN" >> $GITHUB_OUTPUT
          echo "youtubeApiToken=$YOUTUBE_API_TOKEN" >> $GITHUB_OUTPUT
          echo "spAlvtimeAdminClientId=$SP_ALVTIME_ADMIN_CLIENT_ID" >> $GITHUB_OUTPUT
          echo "spAlvtimeAdminRbacSecret=$SP_ALVTIME_ADMIN_RBAC_SECRET" >> $GITHUB_OUTPUT
 
  deploy-website:
    needs: [get-build-tag, get-secrets]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: azure/setup-helm@v3
        with:
          version: '3.10.2'
      - uses: azure/use-kubelogin@v1
        with:
          kubelogin-version: 'v0.0.28'

      - name: Log in to Azure and set subscription
        shell: bash
        run: |
          az login --service-principal \
            -u "${{ vars.INFRA_TEST_SP_CLIENT_ID }}" \
            -p "${{ secrets.INFRA_TEST_SP_SECRET }}" \
            --tenant "${{ vars.TENANT_ID }}"
          az account set --subscription "${{ vars.SUBSCRIPTION_ID_TEST }}"
  
      - name: Build, push and deploy
        shell: bash
        run: |
          ALV_HOSTNAME=${{ needs.get-secrets.outputs.alvHostname }}
          SANITY_TOKEN=${{ needs.get-secrets.outputs.sanityToken }}
          YOUTUBE_API_TOKEN=${{ needs.get-secrets.outputs.youtubeApiToken }}
          SP_ALVTIME_ADMIN_CLIENT_ID=${{ needs.get-secrets.outputs.spAlvtimeAdminClientId }}
          SP_ALVTIME_ADMIN_RBAC_SECRET=${{ needs.get-secrets.outputs.spAlvtimeAdminRbacSecret }}
          TAG=${{ needs.get-build-tag.outputs.buildTag }}

          # Authenticate Azure container registry
          docker login ${{ vars.CONTAINER_REGISTRY }} \
            --username ${{ vars.INFRA_TEST_SP_CLIENT_ID }} \
            --password ${{ secrets.INFRA_TEST_SP_SECRET }}

          # Source services
          source ./packages/website/website-service.sh
          source ./bash-services/aks-service.sh
          source ./bash-services/helm-service.sh
          
          # Build
          buildWebsite \
            ${{ env.ENV }} \
            $SANITY_TOKEN \
            $YOUTUBE_API_TOKEN \
            ${{ vars.CONTAINER_REGISTRY }} \
            $TAG
          
          # Push
          pushWebsite \
            ${{ vars.CONTAINER_REGISTRY }} \
            $TAG
          
          # Get AKS credentials and configure kubectl
          getAksCredentials \
            ${{ vars.AZURE_SUBSCRIPTION_TEST }} \
            ${{ vars.AZURE_RESOURCE_GROUP_NAME_TEST }} \
            ${{ vars.KUBERNETES_CLUSTER_NAME_TEST }} 

          # Pull helm chart
          helmLoginAndPull \
            $SP_ALVTIME_ADMIN_CLIENT_ID \
            $SP_ALVTIME_ADMIN_RBAC_SECRET \
            ${{ vars.CONTAINER_REGISTRY }}
          
          # Deploy to cluster
          deployWebsite \
            $ALV_HOSTNAME \
            ${{ vars.CONTAINER_REGISTRY }} \
            $TAG